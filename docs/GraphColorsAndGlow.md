# Graph Colors and Glow/Highlight Behavior

This document explains where and how node colors and glow/highlight effects are applied in the graph rendering, with pointers to the relevant code.

## Overview

- Node colors are applied by Cosmograph using the node's `node_type` via props in GraphCanvasV2.
- Per-type colors come from `config.nodeTypeColors` with fallbacks generated by `generateNodeTypeColor`.
- "Glow" on node access is implemented by selecting nodes (ring highlight) for 2 seconds; there is no separate glow color in the data preparer.
- The data preparer transforms and sanitizes data; it does not set node colors or glow.

## Node color application (GraphCanvasV2)

Cosmograph is configured to color nodes by `node_type` using a palette and/or a map.

File: `frontend/src/components/GraphCanvasV2.tsx`

```tsx
<Cosmograph
  pointColorBy="node_type"
  pointColorPalette={[
    '#e74c3c','#3498db','#2ecc71','#f39c12','#9b59b6',
    '#1abc9c','#34495e','#e67e22','#95a5a6','#d35400'
  ]}
  pointColorByMap={config.nodeTypeColors || {}}
  ...
/>
```

Notes:
- If `config.nodeTypeColors` contains an entry for a `node_type`, that color is used.
- Otherwise, Cosmograph falls back to the provided `pointColorPalette` cycling by type index.

## Where node type colors come from

Colors are generated or ensured in config using `generateNodeTypeColor`. The Control Panel UI can override per-type colors in `config.nodeTypeColors`.

File: `frontend/src/utils/nodeTypeColors.ts`

```ts
export const generateNodeTypeColor = (nodeType: string, index: number): string => {
  const knownTypeColors: Record<string, string> = {
    Entity: '#B794F6', Episodic: '#4ECDC4', Agent: '#F6AD55',
    Community: '#90CDF4', Unknown: '#9CA3AF'
  };
  if (knownTypeColors[nodeType]) return knownTypeColors[nodeType];
  return colorPalette[index % colorPalette.length];
};
```

Populating defaults in the provider:

File: `frontend/src/contexts/GraphConfigProvider.tsx`

```tsx
if (!newColors[type]) {
  newColors[type] = generateNodeTypeColor(type, index);
}
```

Control Panel usage (users can adjust):

File: `frontend/src/components/ControlPanel/NodeStylingTab.tsx`

```tsx
const actualColor = config.nodeTypeColors[type.id] || generateNodeTypeColor(type.id, index);
```

## Older GraphCanvas function-based color (reference)

In the legacy `GraphCanvas` (not V2), a function was used to resolve colors by `node_type` when `config.colorScheme === 'by-type'`.

File: `frontend/src/components/GraphCanvas.tsx`

```tsx
const pointColorByFn = useMemo(() => {
  if (config.colorScheme !== 'by-type') return undefined;
  return (nodeType: string) => config.nodeTypeColors[nodeType]
    ?? generateNodeTypeColor(nodeType, allNodeTypes.indexOf(nodeType));
}, [config.colorScheme, config.nodeTypeColors, allNodeTypes]);
```

You could port a similar approach to V2 if you need dynamic color functions instead of palette/map.

## Glow / node access highlight behavior in V2

Node access events visually highlight nodes by selecting them in Cosmograph, which shows a focus ring for 2 seconds, then clears the selection. The state is tracked in `glowingNodes`, but the visible effect is the selection ring, not a fill color change.

File: `frontend/src/components/GraphCanvasV2.tsx`

```tsx
if (event.type === 'node_access' && event.node_ids) {
  setGlowingNodes(() => {
    const updated = new Map<string, number>();
    event.node_ids.forEach((nodeId: string) => updated.set(nodeId, Date.now()));
    return updated;
  });
  const indices = event.node_ids
    .map((id: string) => nodes.findIndex(n => n.id === id))
    .filter(i => i >= 0);
  if (indices.length > 0) cosmographRef.current?.selectPoints?.(indices, false);
  glowTimeoutRef.current = setTimeout(() => {
    setGlowingNodes(new Map());
    cosmographRef.current?.unselectAllPoints?.();
  }, 2000);
}
```

Ring highlight colors are configured via props:

```tsx
renderHoveredPointRing={config.renderHoveredPointRing !== false}
hoveredPointRingColor={config.hoveredPointRingColor || '#ff0000'}
focusedPointRingColor={config.focusedPointRingColor || '#0066cc'}
```

There is no `nodeAccessHighlightColor` variable; adjust the above ring colors or implement a custom effect if needed.

## Data preparer does not set colors/glow

The data preparer transforms nodes/links (sanitize, cluster indices, etc.). It doesn’t assign final colors or glow. Node color is derived at render time by Cosmograph based on props and config.

File: `frontend/src/components/GraphCanvasV2.tsx` (data prep flow)

```tsx
const transformedNodes = nodes.map((node, index) => sanitizeNode(node, index, {
  clusteringMethod: config.clusteringMethod,
  centralityMetric: config.centralityMetric,
  clusterStrength: config.clusterStrength,
  nodeTypeIndexMap
}));
```

## How to change node colors or glow

- Per-type colors
  - Update `config.nodeTypeColors` (via Control Panel or programmatically) to set explicit colors for each `node_type`.
  - Modify `generateNodeTypeColor` to change default/fallbacks.
- Function-based color
  - Port the `pointColorByFn` approach from legacy `GraphCanvas` to V2 and pass a color function to Cosmograph (requires adjusting V2 props to use a function instead of `pointColorBy`).
- Highlight/glow visuals
  - Adjust `hoveredPointRingColor` and `focusedPointRingColor` to change ring colors.
  - For a true glow effect (bloom/halo), you’d need a custom shader/overlay or integrate the `graph-refactored`’s `NodeGlowManager` approach into V2 (not currently wired).

## Related files

- `frontend/src/components/GraphCanvasV2.tsx`
- `frontend/src/utils/nodeTypeColors.ts`
- `frontend/src/contexts/GraphConfigProvider.tsx`
- `frontend/src/components/ControlPanel/NodeStylingTab.tsx`
- `frontend/src/components/GraphCanvas.tsx` (legacy reference)
- `frontend/src/hooks/useGraphVisualEffects.ts` (internal visual state/effects; not directly altering Cosmograph colors)

