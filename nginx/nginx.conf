events {
    worker_connections 1024;
}

# HTTP proxy for the web UI
http {
    upstream falkordb_ui {
        server falkordb:3000;
    }

    server {
        listen 3000;
        
        location / {
            proxy_pass http://falkordb_ui;
            proxy_set_header Host $host:3100;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host:3100;
            proxy_set_header X-Forwarded-Port 3100;
            
            # Handle redirects
            proxy_redirect http://localhost:3000/ http://$host:3100/;
            proxy_redirect http://falkordb:3000/ http://$host:3100/;
        }
    }
}

# TCP/Stream proxy for Redis protocol
stream {
    upstream falkordb_backend {
        server falkordb:6379;
    }
    
    server {
        listen 6379;
        proxy_pass falkordb_backend;
        proxy_connect_timeout 5s;
        proxy_timeout 300s;
    }
}